#!/usr/bin/env bash

set -euo pipefail -x

# Check if a date argument was provided
if [ $# -ne 1 ]; then
    echo "Usage: $0 YYYY.MM.DD"
    exit 1
fi

# Validate date format (simple check)
if ! [[ $1 =~ ^[0-9]{4}\.[0-9]{1,2}\.[0-9]{1,2}$ ]]; then
    echo "Error: Date must be in format YYYY.MM.DD"
    exit 1
fi

# Check for modified or staged files only (ignoring untracked files)
if ! git diff-index --quiet HEAD --; then
    echo "Error: Working directory is not clean"
    echo "There are uncommitted changes in tracked files:"
    git status -s | grep -v "^??"
    exit 1
fi

./version "$1"
git add deps.edn package.json package-lock.json pom.xml readme.md
git commit -m "chore: Update version to 2025.3.29"
git tag -a "$1"
git push origin main "$1"
